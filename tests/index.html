<html>

<head>
  <title>My first Three.js app</title>
  <style>
    canvas {
      width: 100%;
      height: 100%
    }
  </style>
</head>

<body>
  <script src="lib/three.min.js"></script>
  <script src="lib/PointerLockControls.js"></script>
  <script src="lib/THREEx.FullScreen.js"></script>
  <script type="text/javascript" src="stats.js"></script>
  <script type="text/javascript" src="lib/physi.js"></script>
  <script>
  Physijs.scripts.worker = 'physijs_worker.js';
  Physijs.scripts.ammo = 'ammo.js';

    initScene = function() {
       spawnBox = (function() {
    var box_geometry = new THREE.CubeGeometry( 4, 4, 4 ),
      handleCollision = function( collided_with, linearVelocity, angularVelocity ) {
        switch ( ++this.collisions ) {
          
          case 1:
            this.material.color.setHex(0xcc8855);
            break;
          
          case 2:
            this.material.color.setHex(0xbb9955);
            break;
          
          case 3:
            this.material.color.setHex(0xaaaa55);
            break;
          
          case 4:
            this.material.color.setHex(0x99bb55);
            break;
          
          case 5:
            this.material.color.setHex(0x88cc55);
            break;
          
          case 6:
            this.material.color.setHex(0x77dd55);
            break;
        }
      },
      createBox = function() {
        var box, material;
        
        material = Physijs.createMaterial(
          new THREE.MeshLambertMaterial({ map: THREE.ImageUtils.loadTexture( 'images/plywood.jpg' ) }),
          .6, // medium friction
          .3 // low restitution
        );
        material.map.wrapS = material.map.wrapT = THREE.RepeatWrapping;
        material.map.repeat.set( .5, .5 );
        
        //material = new THREE.MeshLambertMaterial({ map: THREE.ImageUtils.loadTexture( 'images/rocks.jpg' ) });
        
        box = new Physijs.BoxMesh(
          box_geometry,
          material
        );
        box.collisions = 0;
        
        box.position.set(
          Math.random() * 15 - 7.5,
          25,
          Math.random() * 15 - 7.5
        );
        
        box.rotation.set(
          Math.random() * Math.PI,
          Math.random() * Math.PI,
          Math.random() * Math.PI
        );
        
        box.castShadow = true;
        box.addEventListener( 'collision', handleCollision );
        box.addEventListener( 'ready', spawnBox );
        scene.add( box );
      };
    
    return function() {
      setTimeout( createBox, 1000 );
    };
  })();

      // http://www.html5rocks.com/en/tutorials/pointerlock/intro/

      var havePointerLock = 'pointerLockElement' in document ||
        'mozPointerLockElement' in document ||
        'webkitPointerLockElement' in document;

      if (havePointerLock) {

        var element = document.body;

        var pointerlockchange = function(event) {

          if (document.pointerLockElement === element ||
            document.mozPointerLockElement === element ||
            document.webkitPointerLockElement === element) {

            //camControls.enabled = true;

          }

        }

        var pointerlockerror = function(event) {

          //instructions.style.display = '';

        }

        // Hook pointer lock state change events
        document.addEventListener('pointerlockchange',
          pointerlockchange, false);
        document.addEventListener('mozpointerlockchange',
          pointerlockchange, false);
        document.addEventListener('webkitpointerlockchange',
          pointerlockchange, false);

        document.addEventListener('pointerlockerror',
          pointerlockerror, false);
        document.addEventListener('mozpointerlockerror',
          pointerlockerror, false);
        document.addEventListener('webkitpointerlockerror',
          pointerlockerror, false);

        document.body.addEventListener('click', function(event) {
          // Ask the browser to lock the pointer
          element.requestPointerLock = element.requestPointerLock ||
            element.mozRequestPointerLock || element.webkitRequestPointerLock;

          if (/Firefox/i.test(navigator.userAgent)) {

            var fullscreenchange = function(event) {

              if (document.fullscreenElement ===
                element || document.mozFullscreenElement ===
                element || document.mozFullScreenElement ===
                element) {

                document.removeEventListener(
                  'fullscreenchange',
                  fullscreenchange);
                document.removeEventListener(
                  'mozfullscreenchange',
                  fullscreenchange);

                element.requestPointerLock();
              }

            }

            document.addEventListener(
              'fullscreenchange',
              fullscreenchange, false);
            document.addEventListener(
              'mozfullscreenchange',
              fullscreenchange, false);

            element.requestFullscreen = element.requestFullscreen ||
              element.mozRequestFullscreen || element
              .mozRequestFullScreen || element.webkitRequestFullscreen;

            element.requestFullscreen();

          } else {

            element.requestPointerLock();

          }

        }, false);

      }

      //document.body.addEventListener("keydown", function() {THREEx.FullScreen.request();}, false);
      var clock = new THREE.Clock();
      //Scene, camera renderer
      var theta = 0;
      var phi = 0;
      var pressed = {};

      var camera = new THREE.PerspectiveCamera(75, window.innerWidth /
        window.innerHeight, 0.1, 1000);
      var renderer = new THREE.WebGLRenderer({
        antialias: true
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      camera.lookAt(new THREE.Vector3(
        100*Math.sin(theta),
        100*Math.tan(phi),
        100*Math.cos(theta)));
      //stats

      render_stats = new Stats();
      render_stats.domElement.style.position = 'absolute';
      render_stats.domElement.style.top = '0px';
      render_stats.domElement.style.zIndex = 100;
      document.body.appendChild( render_stats.domElement );
      
      physics_stats = new Stats();
      physics_stats.domElement.style.position = 'absolute';
      physics_stats.domElement.style.top = '50px';
      physics_stats.domElement.style.zIndex = 100;
      document.body.appendChild( physics_stats.domElement );

      //camera.position.z =400 ;

        var scene = new Physijs.Scene;
        scene.setGravity(new THREE.Vector3( 0, -30, 0));
        scene.addEventListener(
        'update',
        function() {
          scene.simulate( undefined, 1 );
          physics_stats.update();
        }
      );

      //Resize
      window.addEventListener('resize', onWindowResize, false);

      //A plane, with tiling texture
      /*var texture = THREE.ImageUtils.loadTexture('grass.b.png');
      texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
      texture.repeat.set(5, 5);
      texture.magFilter = THREE.NearestFilter;
      texture.minFilter = THREE.LinearMipMapLinearFilter;
      var plane = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000),
        new THREE.MeshLambertMaterial({
          map: texture,
          ambient: 0xbbbbbb
        }));
      plane.overdraw = true;
      plane.rotation.x = -Math.PI / 2;
      scene.add(plane);*/

      ground_material = Physijs.createMaterial(
        new THREE.MeshLambertMaterial({ 
          map: THREE.ImageUtils.loadTexture( 'grass.jpg' ) 
        }),
        .8, // high friction
        .9
      );
      ground_material.map.wrapS = ground_material.map.wrapT = THREE.RepeatWrapping;
      ground_material.map.repeat.set( 4, 4 );
      
      ground = new Physijs.BoxMesh(
        new THREE.CubeGeometry(100, 1, 100),
        ground_material,
        0 // mass
      );
      scene.add( ground );


      //A js model exported from blender
      var loader = new THREE.JSONLoader();
      loader.load("blender/monkey.js", function(geometry) {

        mesh = new THREE.Mesh(geometry, new THREE.MeshNormalMaterial());
        mesh.scale.set(10, 10, 10);
        mesh.position.y = 0;
        mesh.position.x = 0;
        scene.add(mesh);
      });

      //Some light
      var ambientLight = new THREE.AmbientLight(0xbbbbbb);
      scene.add(ambientLight);

      //Camera control
      //var camControls = new THREE.PointerLockControls(camera);
      //scene.add(camControls.getObject());

      cameraHitbox = new Physijs.BoxMesh(
        new THREE.CylinderGeometry(4, 4, 12),
        ground_material,
        50 // mass
      );

      cameraHitbox.position.set(0,57,0);
      cameraHitbox.add(camera);
      scene.add( cameraHitbox );

      var constraint = new Physijs.DOFConstraint(
          cameraHitbox, // First object to be constrained
          0,
          new THREE.Vector3( 0, 10, 0 ) // point in the scene to apply the constraint
      );
      scene.addConstraint(constraint);
      constraint.setLinearLowerLimit( new THREE.Vector3( -1e30, -1e30, -1e30) ); // sets the lower end of the linear movement along the x, y, and z axes.
      constraint.setLinearUpperLimit( new THREE.Vector3( 1e30, 1e30, 1e30 ) );
      constraint.setAngularLowerLimit( new THREE.Vector3( 0, 0, 0 ) ); // sets the lower end of the angular movement, in radians, along the x, y, and z axes.
      constraint.setAngularUpperLimit( new THREE.Vector3( 0, 0, 0 ) ); // sets the upper end of the angular movement, in radians, along the x, y, and z axes.

      var i = 0;
      var render = function() {
        requestAnimationFrame(render);

        //keeps the player vertical




        //camControls.enabled = true;
        //camControls.isOnObject(false);
        //camControls.update();
        //cameraHitbox.position.set(0,51,i/100);
        setSpeed();        
        renderer.render(scene, camera);
      };

      function setSpeed() {
        var speed = [0,0,0];

        if (pressed.w) {
          speed[0] += Math.sin(theta);
          speed[2] += Math.cos(theta);
        }

        if (pressed.s) {
          speed[0]+=-Math.sin(theta);
          speed[2]+=-Math.cos(theta);
        }

        if (pressed.a) {
          speed[0]+=Math.sin(theta+Math.PI/2);
          speed[2]+=Math.cos(theta+Math.PI/2);
        }

        if (pressed.d) {
          speed[0]+= Math.sin(theta-Math.PI/2);
          speed[2]+= Math.cos(theta-Math.PI/2);
        }

        if (pressed.jump) {
          if (Math.abs(cameraHitbox.getLinearVelocity().y) < 0.1) {
            speed[1]+=20;
            }
        }
        
        var norm = normalizePlane(speed);
        cameraHitbox.setLinearVelocity(new THREE.Vector3(
            10*speed[0]/norm,
            speed[1] + cameraHitbox.getLinearVelocity().y,
            10*speed[2]/norm
        ));
      }


      spawnBox(scene);
      scene.simulate();
      render();

      function onDocumentMouseMove( event ) {
        oldX = event.clientX;
        oldY = event.clientY;

        theta -= event.webkitMovementX/window.innerWidth*100;
        phi -= event.webkitMovementY/window.innerWidth*100;
        phi = Math.min( Math.PI/2, Math.max( -Math.PI/2, phi ) );

        camera.lookAt(new THREE.Vector3(
            cameraHitbox.position.x + 10000*Math.sin(theta),
            cameraHitbox.position.y + 10000*Math.tan(phi),
            cameraHitbox.position.z + 10000*Math.cos(theta)));
        camera.updateMatrix();
      }

      function onKeydown (event) {

        switch(event.keyCode) {
          case 87: //w
          pressed.w = true;
          break;

          case 83: //s
          pressed.s = true;
          break;

          case 65: //a
          pressed.a = true;
          break;

          case 68: //d
          pressed.d = true;
          break;

          case 32: //jump
          pressed.jump = true;
          break;
        }
        setSpeed();
      }

      // used to stop the slip
      function onKeyup (event) {
       switch(event.keyCode) {
          case 87: //w
          pressed.w = false;
          break;

          case 83: //s
          pressed.s = false;
          break;

          case 65: //a
          pressed.a = false;
          break;

          case 68: //d
          pressed.d = false;
          break;

          case 32: //jump
          pressed.jump = false;
          break;


        }
        setSpeed();
      }

      document.addEventListener( 'mousemove', onDocumentMouseMove, false );
      document.addEventListener( 'keydown', onKeydown, false );
      document.addEventListener( 'keyup', onKeyup, false );


      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    };

    function animate() {

    }

    window.onload = initScene;
    

    function normalizePlane (vec) {
        normsq = vec[0]*vec[0]+vec[2]*vec[2];
       return Math.sqrt(normsq);
    }
  </script>
</body>

</html>